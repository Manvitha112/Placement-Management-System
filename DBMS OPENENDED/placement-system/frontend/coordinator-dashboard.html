<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinator Dashboard - Placement System</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="dashboard-layout">
    <header class="branding-header">
        <div class="brand-main">
            <img src="assets/sit-logo.png" alt="SIT Logo" class="sit-logo">
            <div class="dept-info">
                <h4>DEPARTMENT OF ISE</h4>
                <p>SIT TUMKURU</p>
            </div>
        </div>
        <div class="header-controls">
            <select class="lang-select" id="langSelect">
                <option value="en">English</option>
                <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            </select>
            <button class="theme-toggle" id="themeToggle">üåì MODE</button>
        </div>
    </header>

    <!-- Professional Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            SIT <span>PLACEMENT</span>
        </div>
        <nav class="nav-links">
            <div class="nav-link active" onclick="switchTab('statistics')" data-i18n="co_overview">
                OVERVIEW
            </div>
            <div class="nav-link" onclick="switchTab('students')" data-i18n="co_students">
                STUDENT DIRECTORY
            </div>
            <div class="nav-link" onclick="switchTab('placed')" data-i18n="co_placed">
                PLACED RECORDS
            </div>
            <div class="nav-link" onclick="switchTab('unplaced')" data-i18n="co_pending">
                PENDING PLACEMENTS
            </div>
            <div class="nav-link" onclick="switchTab('companies')" data-i18n="co_partners">
                CORPORATE PARTNERS
            </div>
            <div style="margin-top: auto; padding-top: 2rem;">
                <div class="nav-link" id="logoutBtn" style="color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2)"
                    data-i18n="logout">
                    SIGN OUT
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Workspace -->
    <main class="main-content">
        <header class="header">
            <div style="flex: 1;">
                <h2 id="pageTitle" data-i18n="co_ws_title">Executive Analytics</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;" data-i18n="co_ws_desc">Intelligence dashboard
                    for institutional placement monitoring</p>
            </div>
            <div class="user-profile">
                <span id="userName"
                    style="font-weight: 700; color: var(--primary); letter-spacing: -0.5px;">ADMINISTRATOR</span>
            </div>
        </header>

        <div id="alert" class="alert"></div>

        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content show">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label" data-i18n="co_total_enroll">TOTAL ENROLLMENT</div>
                    <div class="stat-value" id="statTotalStudents">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" data-i18n="co_partners">CORPORATE PARTNERS</div>
                    <div class="stat-value" id="statTotalCompanies">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" data-i18n="co_placed_students">PLACED STUDENTS</div>
                    <div class="stat-value" id="statPlaced">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" data-i18n="co_avg_ctc">AVG CTC (LPA)</div>
                    <div class="stat-value" id="statAvgPackage">0</div>
                </div>
            </div>

            <div class="card"
                style="padding: 2.5rem; border-radius: var(--radius-lg); background: var(--bg-card); border: 1px solid var(--border);">
                <h3 style="margin-bottom: 2rem; font-weight: 800; letter-spacing: -0.5px;" data-i18n="co_dept_perf">
                    Department Performance Index
                </h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n="dept_label">DEPARTMENT</th>
                                <th data-i18n="co_total_enroll">TOTAL STUDENTS</th>
                                <th data-i18n="co_placed_students">PLACED</th>
                                <th data-i18n="co_success_rate">SUCCESS RATE</th>
                                <th data-i18n="co_avg_salary">AVG SALARY</th>
                            </tr>
                        </thead>
                        <tbody id="deptStatsTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Student Directory Tab -->
        <div id="students" class="tab-content">
            <div class="card"
                style="padding: 2.5rem; border-radius: var(--radius-lg); background: var(--bg-card); border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="font-weight: 800; letter-spacing: -0.5px;" data-i18n="co_sis">Student Information System
                    </h3>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="studentSearch" placeholder="Filter USN or Name..."
                            onkeyup="filterStudents()" style="width: 250px;">
                        <select class="form-input" id="deptFilter" onchange="filterStudents()" style="width: 180px;">
                            <option value="">All Departments</option>
                            <option value="CSE">CSE</option>
                            <option value="ISE">ISE</option>
                            <option value="ECE">ECE</option>
                            <option value="EEE">EEE</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>USN</th>
                                <th>NAME</th>
                                <th>DEPT</th>
                                <th>CGPA</th>
                                <th>STATUS</th>
                                <th>ORGANIZATION</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Placed Tab -->
        <div id="placed" class="tab-content">
            <div class="card">
                <h3 data-i18n="co_success_records">Success Records</h3>
                <div class="table-container mt-2">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>STUDENT</th>
                                <th>DEPT</th>
                                <th>COMPANY</th>
                                <th>ROLE</th>
                                <th>CTC (LPA)</th>
                                <th>JOINING DATE</th>
                            </tr>
                        </thead>
                        <tbody id="placedTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Unplaced Tab -->
        <div id="unplaced" class="tab-content">
            <div class="card">
                <h3 data-i18n="co_eligible_pending">Eligible Candidates Pending</h3>
                <div class="table-container mt-2">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>CANDIDATE</th>
                                <th>DEPT</th>
                                <th>CGPA</th>
                                <th>APPLICATIONS</th>
                                <th>CONTACT EMAIL</th>
                            </tr>
                        </thead>
                        <tbody id="unplacedTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Companies Tab -->
        <div id="companies" class="tab-content">
            <div class="card">
                <h3 data-i18n="co_rec_partners">Recruitment Partners</h3>
                <div class="table-container mt-2">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ORGANIZATION</th>
                                <th>DESIGNATION</th>
                                <th>BASE CTC</th>
                                <th>APPS</th>
                                <th>SHORTLISTED</th>
                                <th>CONVERTED</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script>
        redirectIfNotAuthenticated();
        updateNavbar();
        loadCoordinatorDashboard();
        // also load department stats for the overview index
        loadDepartmentStats();

        function updateNavbar() {
            document.getElementById('userName').textContent = getUserName() || 'Coordinator';
            document.getElementById('logoutBtn').onclick = () => {
                logout();
                window.location.href = 'index.html';
            };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
            document.getElementById(tabName).classList.add('show');
            document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));

            // Find the nav-link that corresponds to this tabName and add active
            const navLinks = document.querySelectorAll('.nav-link');
            if (tabName === 'statistics') navLinks[0].classList.add('active');
            if (tabName === 'students') navLinks[1].classList.add('active');
            if (tabName === 'placed') navLinks[2].classList.add('active');
            if (tabName === 'unplaced') navLinks[3].classList.add('active');
            if (tabName === 'companies') navLinks[4].classList.add('active');

            document.getElementById('pageTitle').textContent =
                tabName === 'statistics' ? getTranslatedText('cot_statistics') :
                    tabName === 'students' ? getTranslatedText('cot_students') :
                        tabName === 'placed' ? getTranslatedText('cot_placed') :
                            tabName === 'unplaced' ? getTranslatedText('cot_unplaced') : getTranslatedText('cot_companies');

            if (tabName === 'statistics') loadDepartmentStats();
            if (tabName === 'students') loadAllStudents();
            if (tabName === 'placed') loadPlacedStudents();
            if (tabName === 'unplaced') loadUnplacedStudents();
            if (tabName === 'companies') loadCompanies();
        }

        async function loadCoordinatorDashboard() {
            try {
                const result = await apiCall('/coordinator/statistics');
                if (result.success) {
                    const s = result.data;
                    const setSafeText = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = val;
                    };
                    setSafeText('statTotalStudents', s.totalStudents);
                    setSafeText('statTotalCompanies', s.totalCompanies);
                    setSafeText('statPlaced', s.placedStudents);

                    const avg = Number(s.avgPackage);
                    const avgDisplay = !isNaN(avg) && isFinite(avg) ? avg.toFixed(2) : '--';
                    setSafeText('statAvgPackage', avgDisplay);
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadAllStudents() {
            try {
                const result = await apiCall('/coordinator/students');
                if (result.success) {
                    window.allStudents = result.data;
                    filterStudents();
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const dept = document.getElementById('deptFilter').value;
            const filtered = window.allStudents.filter(s =>
                s.Stud_Name.toLowerCase().includes(search) &&
                (!dept || s.Dept === dept)
            );
            const rows = filtered.map(s => `
        <tr>
          <td style="font-weight: 600;">${s.USN || '-'}</td>
          <td>${s.Stud_Name}</td>
          <td>${s.Dept}</td>
          <td>${s.CGPA}</td>
          <td><span class="badge badge-${s.PlacementStatus === 'Placed' ? 'success' : 'danger'}">${s.PlacementStatus}</span></td>
          <td>${s.Comp_Name || '-'}</td>
        </tr>
      `).join('');
            document.getElementById('studentsTbody').innerHTML = rows || '<tr><td colspan="8">No students found</td></tr>';
        }

        async function loadPlacedStudents() {
            try {
                const result = await apiCall('/coordinator/placed-students');
                if (result.success) {
                    const rows = result.data.map(s => `
            <tr>
              <td>${s.Stud_Name}</td>
              <td>${s.Dept}</td>
              <td>${s.CGPA}</td>
              <td>${s.Comp_Name}</td>
              <td>${s.Role}</td>
              <td>${s.Salary}</td>
              <td>${new Date(s.Join_Date).toLocaleDateString()}</td>
            </tr>
          `).join('');
                    document.getElementById('placedTbody').innerHTML = rows || '<tr><td colspan="7">No placed students</td></tr>';
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadUnplacedStudents() {
            try {
                const result = await apiCall('/coordinator/unplaced-students');
                if (result.success) {
                    const rows = result.data.map(s => `
            <tr>
              <td>${s.Stud_Name}</td>
              <td>${s.Dept}</td>
              <td>${s.CGPA}</td>
              <td>${s.Email}</td>
              <td>${s.Phone}</td>
              <td>${s.ApplicationCount}</td>
            </tr>
          `).join('');
                    document.getElementById('unplacedTbody').innerHTML = rows || '<tr><td colspan="6">All students are placed!</td></tr>';
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadCompanies() {
            try {
                const result = await apiCall('/coordinator/companies');
                if (result.success) {
                    const rows = result.data.map(c => `
            <tr>
              <td>${c.Comp_Name}</td>
              <td>${c.Role}</td>
              <td>${c.Package}</td>
              <td>${c.Total_Applications || 0}</td>
              <td>${c.Shortlisted || 0}</td>
              <td>${c.Selected || 0}</td>
            </tr>
          `).join('');
                    document.getElementById('companiesTbody').innerHTML = rows || '<tr><td colspan="6">No companies</td></tr>';
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function loadDepartmentStats() {
            try {
                const result = await apiCall('/coordinator/department-stats');
                if (result.success) {
                    const rows = result.data.map(d => `
            <tr>
              <td><strong>${d.Dept}</strong></td>
              <td>${d.Total_Students}</td>
              <td>${d.Placed_Students}</td>
              <td>${d.Placement_Percentage}%</td>
              <td>${d.Avg_Package || 0}</td>
            </tr>
          `).join('');
                    document.getElementById('deptStatsTbody').innerHTML = rows || '<tr><td colspan="5">No data</td></tr>';
                }
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
    </script>
</body>

</html>